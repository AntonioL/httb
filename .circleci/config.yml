version: 2
jobs:
  build:
    docker:
      - image: debian:jessie
        environment:
          CXX: /usr/bin/g++
          CC: /usr/bin/gcc
    steps:
      - run: apt-get update
      - run: apt-get install -y git
      - run:
          name: Cloning repo
          command: git clone --recursive https://github.com/edwardstock/httb .
      - run:
          name: Preparing
          command: $(which bash) .circleci/setup.sh
      - save_cache:
          key: custom_pkgs
          paths:
            - /tmp/pkgs
      - run: mkdir -p build
      - run: export CC=/usr/bin/gcc
      - run: export CXX=/usr/bin/g++
      - run:
          name: Configuring
          command: cd build && cmake .. -DCMAKE_BUILD_TYPE=Debug -DWITH_TEST=ON

      - save_cache:
          key: conan_dir
          paths:
            - /root/.conan
      - run: cmake --build ./build
      - run: cmake --build ./build --target httb-test
      - run:
          name: Testing
          command: ./build/bin/httb-test